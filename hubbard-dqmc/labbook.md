# 2022.4.28

从旧代码里面找来了一个Hubbard DQMC的程序`hubbard-old-code.jl`，看看能不能修改得generic一些。

先测试一下能不能用：取$U=1$，输出为
```
T -1.4777923120276673 0.004471842143327594
Mott 0.20837948635182507 0.000888249213972672
```
第一列为平均值，第二位为标准差。

在`hubbard-old-code-renamed.jl`中修改一些名称，使得后续的模块化更容易进行。
修改了一部分，取$U=2$，有

```
Progress: 100%|████████████████████████████████████████████████████████████████████| Time: 0:14:43
T -1.431692758497201 0.0051304951942906215
Mott 0.1799663182632188 0.0011940302855397808
```

初步计划：
- 将主循环移动到`main.jl`
- 构建格点的移动到`lattice.jl`
- 理想情况下，可以先写一个generic的版本用来计算$\ee^{- \Delta \tau T}$，然后写一个专属于正方晶格的版本做checkboard decomposition。

# 2022.4.30

目前还没有做的事情：
- 将自旋上和自旋下的各种函数合并（是否有这个必要？性能overhead？）

提交
```
U = 4.0
β = 4.0
```
的任务，slurm id为1262582。输出为`slurm-1262582.out`，应该是没啥问题。

将checkboard decomposition的无用代码（它们应该在计算$\exp(-\Delta \tau \bold{T})$乘以别的矩阵时出现，现在我先把$\exp(-\Delta \tau \bold{T})$算好存起来，那用不用checkboard decomposition没有差别）注释掉，重新做计算，扩大规模。

目前的规模：
```julia
L = 10 
lattice = SquareLattice2D(L)
n_sites = lattice.n_sites

t = 1.0
U = 4.0
β = 4.0
n_imtimes = 100
n_wrap = 10

n_heat = 1000
n_sweep = 4000

n_bin = 10
```

更新服务器上的代码，跑一下试一试。slurm id为1263693。

似乎`println`更新不及时；加入了一些`flush(stdout)`语句，再看看。
此时
```
t = 1.0
U = 2.0
β = 4.0
```
slurm id为1265098。

1265098超时了。看来最好还是从$L=4$开始做。

可以做的事情：
- 计算$L=10$时扫一次要多久

运行
```julia
@time sweep!(model, 1)
```
得到
```
 33.939589 seconds (3.29 M allocations: 12.192 GiB, 2.80% gc time)
```
确实很长……

按照
```julia
L = 10 
lattice = SquareLattice2D(L)
n_sites = lattice.n_sites

t = 1.0
U = 4.0
β = 4.0
n_imtimes = 100
n_wrap = 10

n_heat = 1000
n_sweep = 4000

n_bin = 10
```
的规模，总计扫了$1000 + 10 \times 4000 = 41000$次，需要的时间是
```julia
33.939589 * 41000 / 3600
```
也就是386个小时！预热的时间也要9小时。

我觉得我还是试一试不同的$L$下扫一次需要的时间为好。

| $L$ | 时间(s) |
| :------ | :------ |
| 4 | 0.735203 |
| 5 | 1.568580 |
| 6 | 2.041254 |
| 7 | 7.743210 |
| 8 | 12.953749 |
| 9 | 20.645465 |
| 10 | 33.939589 |

这意味着$L=4$的情况也需要8小时。

在加入磁化率计算之后，使用如下小规模计算：
```julia
#region Model parameters

t = 1.0
U = 2.0
β = 4.0

#endregion

#region Problem size

L = 4 
lattice = SquareLattice2D(L)
n_sites = lattice.n_sites
site_list = lattice.site_list

n_imtimes = 100
n_wrap = 10

#endregion

#region Sweeping control

n_heat = 100
n_sweep = 400
n_bin = 10

#endregion
```

似乎磁化那里有问题。（还没扫完，但是前两个bin都是0.07左右）设置$U=0$，只扫描一个bin，得到
```
Square lattice 2D Hubbard simple DQMC


t   =    1.0
U   =    0.0
β   =    4.0

n_sites   =   16
n_imtimes =   100
n_wrap    =   10

n_heat    =   100
n_sweep   =   400
n_bin     =   1

Heating up finished.


====================================================
E_kin            double_occ    magnetization
====================================================
-1.4993291872    0.2500000000    0.0507602959 

====================================================

E_kin      =   -1.4993291872038983 ± NaN
double_occ =   0.25000000000000255 ± NaN
mag        =   0.050760295887215943 ± NaN
```
然而`mag`那里应该是0.01才对。

看了xxy的代码，好像因为自旋1/2要乘以1/4.

# 2022.5.2

```
Square lattice 2D Hubbard simple DQMC


t   =    1.0
U   =    4.0
β   =    4.0

n_sites   =   16
n_imtimes =   80
n_wrap    =   10

n_heat    =   256
n_sweep   =   500
n_bin     =   10

Heating up finished.


====================================================
E_kin            double_occ    magnetization
====================================================
-1.2883900103    0.1263416438    0.0250162846 
-1.3265434500    0.1263442690    0.0241612521 
-1.3294948606    0.1297493972    0.0232511839 
-1.2984369824    0.1261373714    0.0230808026 
-1.3168504913    0.1273670216    0.0239027212 
-1.3318833696    0.1291119323    0.0238116144 
-1.3298143501    0.1283875584    0.0226089581 
-1.3229039686    0.1293443291    0.0246821311 
-1.3168847097    0.1246721660    0.0229960583 
-1.3164177116    0.1273062922    0.0242404025 

====================================================

E_kin      =   -1.3177619904159725 ± 0.014241814897954314
double_occ =   0.12747619810353122 ± 0.0016474852592948427
mag        =   0.023775140861315887 ± 0.000779587823173299
```
好像磁化还是不太对。按理说应该到0.4左右的。

不得了，
```
Square lattice 2D Hubbard simple DQMC


t   =    1.0
U   =    8.0
β   =    4.0

n_sites   =   16
n_imtimes =   80
n_wrap    =   10

n_heat    =   256
n_sweep   =   500
n_bin     =   10

Heating up finished.


====================================================
E_kin            double_occ    magnetization
====================================================
-1.3098040481    0.0853053024    0.0250521394
-1.3351000077    0.0822370305    0.0266899579
-1.3279017986    0.0780042056    0.0262938533
-1.3296764764    0.0860492974    0.0267774410
-1.2993335280    0.0784472301    0.0266273681 
-1.3009280277    0.0838030757    0.0266839978 
-1.2911186243    0.0842881694    0.0253331564 
-1.3188339145    0.0834682716    0.0263674546 
-1.3265920283    0.0829677562    0.0254058166 
-1.3253439059    0.0794912459    0.0275272224 

====================================================

E_kin      =   -1.3164632359508972 ± 0.015133855566759936
double_occ =   0.08240615848402601 ± 0.0028321553997072996
mag        =   0.026275840740776962 ± 0.0007768149917073065
```
好像能量也是错的。

为了检查什么地方有问题，运行`hubbard-old-code.jl`观察。取`U = 8.0`：输出为
```
Progress: 100%|████████████████████████████████████████████████████████████████████| Time: 0:11:59
T -1.3325295647020048 0.017945595434198054
Mott 0.08478973723069207 0.0020585114638910075
```

因此出问题的是从`hubbard-old-code.jl`出发开发得到的所有代码。

我翻箱倒柜找出来一份（至少是动能部分）能用的python代码，见`hubbard-first-workable.ipynb`。

修改`hubbard-dqmc\old-code-1\observe.jl`来加入双占据和磁化率。

这个是`U=4`的结果：
```
Observables:
-1.386758269199109    0.1273138964821045    0.018489855621334022 - 4.453712996395483e-34im
-1.091704819170557    0.10858478261572828    0.005397459313792592 + 2.6481536735324493e-34im
-1.2505778003427    0.12831190793975064    0.0069882008880233736 - 1.925929944387236e-34im
-0.856805508013271    0.07840708962484642    0.09869432093298189 + 3.1476917528578886e-33im
-1.4441316307480951    0.13604924882398164    0.06319243550840957 - 3.562970397116386e-33im
-1.3459642244878807    0.15292379674670178    0.011080264091162847 - 8.125016952883651e-35im
-1.6126020277577149    0.14294948831622148    0.008828644681578688 + 4.333342374871281e-34im
-1.2824036996071433    0.11898478502095616    0.009294689681281105 + 1.1886598875514971e-34im
-1.3564575306617304    0.15671368765794372    0.018657245634200844 + 3.1898214703913594e-34im
-1.5728057091868854    0.11549655399571956    0.06042086191714472 + 9.990761586508786e-34im
-0.9722419024461892    0.07964070328763057    0.026959303729339943 + 3.912045199536573e-34im
-0.9927315266002052    0.09573539594665947    0.013449915357943399 + 5.416677968589101e-34im
-1.5242154377373782    0.13814523413798352    0.010226997486126984 - 4.81482486096809e-34im
-1.707945207445699    0.14384932930555636    0.00738739743448671 - 6.357073449246931e-35im
-1.0441940441647268    0.06666693017213228    0.022404745058449416 + 6.138901697734314e-34im
-1.2632746261686814    0.15079422154179806    0.014856131452622748 - 6.319457630020618e-35im
-1.501596031193834    0.1585392627303986    0.013711020653898115 - 4.724546894824938e-34im
-1.3521825577906266    0.12747190796807606    0.00665511954994903 + 6.018531076210112e-35im
-1.0585830813663235    0.10734340568459076    0.03463232446733806 + 2.8888949165808538e-34im
-1.1067857758591075    0.10704004398150374    0.06515240494012324 + 2.2689862157312122e-33im
-1.3653974212223008    0.1497178651375587    0.03152175952744882 + 1.0833355937178202e-33im
-1.530540857286606    0.15141440007905665    0.01043942165466644 - 6.018531076210112e-35im
-1.6676518073259785    0.12453418505174652    0.05141494235190663 - 8.305572885169955e-34im
-1.279789948150936    0.10076236245516072    0.02116305107746056 - 3.1296361596292583e-34im
-1.2544096581548552    0.13092630667154617    0.034365969573973 - 8.666684749742561e-34im
-1.4072495300225754    0.12123625888590894    0.08344135918329172 - 3.2138955946962e-33im
-1.635395089237635    0.14899634873488038    0.007842505723090832 + 3.0393581934861066e-34im
-1.2365983940188645    0.11201636727948967    0.04009129422325051 + 2.840746667971173e-33im
-1.6008084089858294    0.14609543915566464    0.019780595651207284 + 6.710662149974275e-34im
-1.3215918677048994    0.11839935395227216    0.10671830647373909 - 1.0532429383367696e-33im
-1.195514068780496    0.1149720106152691    0.04353776648347747 + 6.229179663877466e-34im
-1.2853251954644382    0.0894738628999314    0.06716354635027916 - 2.6481536735324493e-34im
-1.122078408176372    0.11201352346908926    0.0621163016918309 - 8.666684749742561e-34im
-1.1252770829947558    0.11842037502112522    0.010979016960107868 + 5.115751414778595e-34im
-1.3363889965900464    0.12903877721474852    0.007165547860543699 + 1.4444474582904269e-34im
-1.275319204218795    0.1276557090894357    0.049706183428676505 + 1.239817401699283e-33im
-1.4510003910676244    0.1385862871888006    0.010470742896197262 + 2.6481536735324493e-34im
-1.086653278272005    0.10703831644269704    0.11730375260481336 + 4.2129717533470784e-34im
-1.2422166604926486    0.1482430403162402    0.03168485303146308 - 1.2638915260041235e-33im
-0.9445840655200782    0.10041203642267685    0.011288233646653618 - 5.296307347064899e-34im
-1.2995607330329548    0.1186227644351255    0.13214285428080436 + 8.943537179248226e-33im
-1.4275665819237378    0.1516372141050035    0.019753825875096716 + 3.611118645726067e-35im
-1.2826962936686686    0.13278929591547792    0.06880407548346396 - 1.0712985315654e-33im
-1.2156833785638996    0.10601952322303874    0.09541749486209149 + 9.810205654222483e-33im
-1.3262813616405627    0.15466508875573498    0.0194582063860352 + 6.500013562306921e-34im
-0.9741101524111964    0.09432148649083233    0.08203197804038315 - 3.803711640164791e-33im
-1.0833158557688338    0.1116021755435731    0.06476359146193014 - 4.55903729022916e-34im
-1.3521615264552738    0.1117210225098708    0.12096629131211893 - 1.9620411308444965e-33im
-1.1320067660720643    0.10993917609197575    0.125279167451156 + 8.341684071627215e-33im
-1.2970105764955404    0.11775768585245074    0.044102632446779734 + 3.851859888774472e-34im
-1.3076924000324368    0.13050774749078026    0.08403483639923912 + 1.2037062152420224e-33im
-1.375677014343375    0.12636623772238603    0.09720338255355818 - 7.2222372914521344e-34im
-1.350882989974761    0.11975426854280852    0.12924282592934663 + 3.1416732217816785e-33im
-1.4787361393582334    0.08469658144732291    0.1683118640709009 + 6.018531076210112e-35im
-1.2344905739170224    0.09141588121161784    0.15742065652036127 - 2.8768578544284336e-33im
-1.3950072307951944    0.08005124838135562    0.11648302536858847 + 6.391680002935139e-33im
-1.450725359284462    0.16046921993037475    0.009433856451860661 + 9.62964972193618e-34im
-1.934360675499192    0.16343865470207727    0.05341425537111059 + 6.018531076210112e-34im
-1.2876504194280725    0.10633577580002619    0.12038297396307537 + 1.4083362718331662e-33im
-1.351293994224839    0.13140106433747353    0.05085095173559678 + 6.2592723192585165e-34im
-1.4331166430138973    0.14144749362417058    0.061501817233246124 + 1.2157432773944426e-33im
-0.8868472014518194    0.08309590409668784    0.03186508169845393 + 1.0833355937178202e-34im
-1.365477750279556    0.1597674526842859    0.010591346189948973 + 9.027796614315168e-35im
-1.069333542072723    0.11490394915061355    0.009459129721337126 + 3.550933334963966e-34im
-1.1580288760141526    0.11963471312820691    0.02073100280591175 + 9.62964972193618e-35im
-1.3003102014555434    0.13256946878371545    0.05088620399162602 + 8.185202263645752e-34im
-1.5382452793738062    0.14414713344926894    0.0069261417048078035 + 9.62964972193618e-35im
-1.3434149825964916    0.15469781473925556    0.04212053995492734 - 1.7333369499485123e-33im
-1.300136157769283    0.13607749304702957    0.007114852179918539 - 2.0252357071447027e-33im
-1.3519310059634873    0.14860384367179022    0.00949256791743499 - 4.363435030252331e-34im
-1.4329729799817874    0.13888341981554123    0.007003189700387319 - 4.2129717533470784e-34im
-1.4683168941493339    0.1368691936049089    0.09856634807710665 - 3.069450848867157e-34im
-1.062425085406443    0.09997147880215124    0.06381789964292967 - 3.5750074592688066e-33im
-1.2418645673949436    0.1419266027785781    0.048705203356952165 + 3.322229154067982e-33im
-1.2145958596748505    0.12494304103267027    0.025485586072746556 - 3.129636159629258e-33im
-1.3013130736202347    0.12366064732171936    0.017887194733760513 + 1.023150282955719e-34im
-1.3769509251317906    0.13400057465829518    0.038436821883092956 + 4.694454239443887e-34im
-1.201321505321957    0.13216174705326017    0.014652730803910574 - 4.438666668704958e-34im
-1.171838053764517    0.140870517557414    0.012845312695834759 - 9.328723168125674e-35im
-1.7383754357179872    0.13093705585642673    0.11753626106568726 - 3.0814879110195774e-33im
-1.5713599960864078    0.1596691434244673    0.044066415978199776 - 5.657419211637505e-34im
-1.173606921276345    0.076234359556301    0.1407033302241125 + 4.718528363748728e-33im
-1.1783072865532576    0.09622853322564215    0.0565542402957543 + 5.657419211637505e-34im
-1.2827404773598032    0.12530244148018954    0.040174504011689476 - 3.4606553688208144e-34im
-1.2799030371891025    0.11831661013140767    0.04840693795874239 + 5.476863279351202e-34im
-1.390001226014281    0.11834108635661779    0.03997728938248693 - 7.462978534500539e-34im
-1.7428190967610653    0.15497386621199197    0.026436417626235144 - 6.2592723192585165e-34im
-1.226782100692735    0.1258358889557796    0.02244299215466254 - 3.942137854917623e-34im
-1.0043912896489724    0.09675227802631425    0.024043721969908824 + 9.990761586508786e-34im
-1.1066944315921612    0.08608982127691125    0.05458444699083425 + 1.3361138989186449e-33im
-0.8914543201246801    0.0790346851914729    0.09260057839747597 + 1.817596385015454e-33im
-1.6889794067283386    0.15533143122979987    0.0824630140850066 + 1.117189831021502e-33im
-1.2878240995167323    0.11408266329700592    0.13155367426732695 - 2.0041708483779673e-33im
-1.2651135254656114    0.0790376437725785    0.16513475170815453 - 3.903017402922258e-33im
-1.2260927254333458    0.11338269099535489    0.08842949056528175 - 8.546314128218359e-34im
-1.5006576300414034    0.1569716021262263    0.04304779849746588 - 6.18404068080589e-34im
-1.0174504007691754    0.06174132816668846    0.04222114609098226 - 8.06483164212155e-34im
-1.1965256010986138    0.05001812311853292    0.03606152931569236 - 2.2870418089598426e-34im
-1.4985754178962862    0.13155607959520485    0.01127367227443646 + 1.6851887013388314e-34im
-1.2352023294101988    0.12216534283474957    0.035288711760053305 + 2.0824117523686988e-33im
Binned Kinetic energy: -1.3036595910633904
```
我真的弱智，没看清楚就算了`U=4`。

改用`U=8`。
```
Observables:
-1.0672577136250523    0.07140283513297203    0.016600489902454104
-1.3592717255330358    0.08970877110554308    0.004583913491265618
-1.094405541054193    0.03823520750275488    0.038064970595690355
-0.6904091152473086    0.03409052579782335    0.011337050143638401
-1.2904895776891818    0.08205298703091043    0.004766769192507611
-2.487516559171748    0.03315332557931881    0.018316290227610086
-0.5789103811513002    0.04261017493843872    0.022604293525163927
-0.8144595016044369    0.0232344018248853    0.028108944119586206
-0.4796760275789939    0.02627448256417988    0.003856088436066101
-0.6938692354899839    0.04315705478518573    0.0029883637990841382
-0.4573354789886472    0.047695362349159214    0.00772139815853495
-1.0337563129663754    0.02126439612448929    0.006289539081908665
-1.123287359258038    0.045292416453520626    0.004426132060717703
-1.02164943328233    0.045449852394178335    0.0028650617459506146
-0.48763509418043893    0.043273924371591076    0.002421231435687345
-2.0155911706593455    0.08548127039833224    0.005961706567725994
-1.623785062427756    0.05790117557940062    0.06484251588170806
-0.5968167211935738    0.0402012564057365    0.03168566706936181
-0.691464919012508    -0.039180682961563046    0.005392822912592228
-1.4210219800602895    0.05282855105106633    0.007318446506509036
-0.9289438924628988    0.020735715473745326    0.08557990792662498
-1.5646163333194358    0.05407249917277538    0.033049800823649236
-0.5250229091325713    0.029511268117534885    0.004560104481747762
-1.3264085657922393    0.02179081564889665    0.00413210248426283
-0.8032709142554862    0.03271314763682813    0.00833990973635617
-0.9232392535815865    0.041982113188691814    0.006776831899054133
-0.6562978946513842    0.02070515257737274    0.003966394114886575
-0.6861313201535488    0.04353341249502715    0.003312024796808076
-1.2012565003539537    0.07664714664363212    0.011546189882548944
-0.7970774571525816    0.06433770366446998    0.0033922901268803683
-1.0083144040056298    0.05778685613751033    0.0027310006742284803
-0.5939000356751113    0.030919916562168116    0.006036183865476651
-1.1005856136441683    0.08496113115263249    0.00997193369695994
-0.5327980887086047    0.022204132178537127    0.006352851613068597
-0.9260751455628694    0.021940247268365878    0.005614583779870864
-0.9370997050151008    0.04816638617597053    0.016191777216234778
-0.6965165428019149    0.06621792387543142    0.003103691985921204
-0.4804518065638338    0.013154792244469948    0.01709413070873817
-1.0812945220066392    0.07329410114003437    0.010779920604727754
-0.6477275385185115    0.03533546091784384    0.011669912257961566
-0.2542124372588592    0.00904901273414322    0.01754932351792193
-0.5890962367823319    0.03116935057353875    0.019057324819868448
-0.49361745970302306    0.019203860501818534    0.012910942050560655
-1.3936803717136925    0.08131182909084737    0.0375825870093752
-2.7283642853670393    -0.6431194401255003    0.018654195004654102
-0.6225903750295378    0.017290256860376774    0.059640002032169834
-1.2928336167078531    0.10606987107866458    0.04584917715263044
-1.1593442611384548    0.06550860315347015    0.16535784802592524
-1.0168321453931828    0.07372483563458697    0.16939649996227812
-0.7724626745887277    0.03286396571291348    0.21658103773298454
-1.6401996144932387    0.09808723865187315    0.11389708671453959
-1.0719801390610524    0.07350621458679545    0.07929785874489795
-0.8123709095051652    0.021811273812247088    0.019132455397447824
-0.7835853393779839    0.04701274409052385    0.10714150539748174
-0.9671788563729887    0.03414107196176151    0.11579925602392885
-0.8155068038752494    0.03560443490854649    0.11525776987732099
-0.9259441324348572    0.050631874505431516    0.10481339589917606
-0.777355102288362    0.05039075708173119    0.043493220973482107
-0.5144712816802457    0.022387267695527575    0.055388329823935115
-1.1147724197523141    0.08095081794615579    0.141010141470354
-0.8300362581992955    0.03278813181013351    0.21892928826251093
-0.5547180473638913    0.009751267026224673    0.2408365219457365
-1.1397322174375093    0.05934025541375475    0.17680142814194344
-1.2668059055706447    0.058756015567594924    0.18984038159509964
-1.1467930443023    0.0359712515423358    0.21513096403842116
-1.4072922218779256    0.08243025408723563    0.09572550129546213
-1.1779659836981042    0.02389186560376077    0.12456500660551749
-2.204386790370103    0.07585044632854339    0.1682373081832834
-1.119010195906616    0.05232608915002716    0.16146461186333202
-1.2145743710291868    0.10310626718401146    0.061584500051348585
-1.2338445566709373    0.09605019989280471    0.08586326556730589
-0.8921100970309517    0.02181104881130586    0.22915975748782189
-1.0751823248369234    0.07019941679928504    0.18096106766745754
-0.7499605408179285    0.05509000396147052    0.174233622310171
-0.8609820072083432    0.0439096852282576    0.20329592602109842
-0.6017887674763351    0.013745432968817124    0.23706168959978652
-0.7362772684484203    0.03226072620329527    0.21766597669385557
-1.0365376725419333    0.045675406405594886    0.2041365598946876
-0.8125715597996168    0.023003982955726258    0.22805298076373137
-1.0731755986594786    0.05707895073243104    0.17599612051302047
-1.0375942142074337    0.0572206201978269    0.19451287983459264
-0.7717249561601287    0.019739212435312476    0.23124904035954935
-1.229902863456308    0.02714371614814239    0.22401846744372786
-1.0390718846927034    0.054833406933252095    0.19108642032167542
-1.2313360426759792    0.06376520934173821    0.1641932139769317
-0.919239824112682    0.06029623124182052    0.15799880550791323
-0.8449282448312814    0.019982396246367037    0.23105101934434263
-0.9736959699450873    0.05660514846261979    0.19156649185099303
-0.7929013659606252    0.03350993577466409    0.21528388510472174
-0.9830889351728342    0.0705534515906322    0.11059754071034529
-1.5778889519229597    0.11052400168530357    0.1254760903081574
-0.8930669199202048    0.04546473997952422    0.20419990557465803
-1.1035347478695594    0.07282932480259406    0.15566524359596526
-0.73222482305895    0.03866993683294019    0.1161265509158523
-0.8625053923760362    0.03838187460567506    0.11195980733226095
-0.6519612505600451    0.027495165759170624    0.062047597535093126
-0.5564139599643725    0.009444241686700203    0.13452996687684024
-0.9028031506619951    0.047315142350429884    0.1071199293910258
-1.292161682730737    0.08219442309328885    0.08060213335739061
-0.964081937356867    0.060487850541910214    0.1801272232320292
Binned Kinetic energy: -0.9868590836294 ± 0.40516526777676487
Binned double occupation: 0.040412257785378373 ± 0.07359126749426709
Magnetization: 0.0898111788623636 ± 0.08230151067851081
```
因此至少这个代码应该是能用的……

我想起来好像`old-code-1`代码是我后来改过的，无怪乎……

于是现在我们将来自`hubbard-old-code.jl`的代码打包放进`old-code-2`文件夹。
我们需要做的是将`old-code-2`和`old-code-1`结合起来，使用`old-code-2`的代码组织方式，内容还是`old-code-1`。

将`old-code-1`的内容复制出来。

尝试将lattice替换掉。（使用`old-code-2`）移除了原本手动计算格点信息的代码，做测试。

应该是没问题。这里$U=8$
```
Observables:
-1.6317112391194946    0.08472192027917823    0.016559767224498548
-0.7735339480296001    0.05680257114441483    0.012960476905189687
-1.3969239604736785    0.08460748208809189    0.004871789077362654
-0.6978537861519053    0.03846528041808516    0.003468989583930125
-0.7597029373471045    0.044573400225579804    0.016819935319744676
-1.2797040477808017    0.07345240485215143    0.020812741809907172
-0.9640903053026422    0.08891025623122126    0.02936800029275481
-0.41322152752696917    0.01528903257562668    0.004049226905364165
-0.5428481376092609    0.02722521258175821    0.003995865221215092
-0.6978565567922262    0.029174969337256416    0.006997822255777623
-1.082423347563536    0.043130052429798685    0.003286074189660179
-1.147469778834213    0.061573297610613135    0.0036865300943854833
-0.44241505604491516    0.01920057921630241    0.007058347523765607
-0.8676928887635238    0.042000039433840175    0.009737760624154844
-0.8223143686314052    0.054478752338533686    0.041855586865169235
-1.5167584273057855    0.0565103637402459    0.004538051790253286
-0.5784176616975656    0.03574427976190624    0.0087044073702723
-0.6881303006422278    0.03544419788595601    0.02536942821123161
-1.4908595842041574    0.03322572272221962    0.035888360566372124
-0.9757625404141339    0.058740151145026565    0.01873577122672418
-0.953793292157544    0.03889641502617852    0.032889138203181734
-1.0983151886547917    0.055746139021759664    0.0493592207840274
-0.9390096966880954    0.06828474922715384    0.09456054159091891
-0.7298908511576172    0.06073748510876205    0.021503342047329968
-0.646688291273551    0.04135566452782742    0.022853883577162098
-1.344412359540092    0.0512678535635563    0.019822120251434847
-1.2983143256198248    0.05855781763933073    0.02266364518455883
-1.0628590236813382    0.08539174900325575    0.006608809382566496
-1.1933809061855325    0.049208668892375455    0.020339144983478028
-1.0306256838350571    0.09491528550567743    0.010558920670681227
-0.44075590774083484    -0.008405978707621801    0.051649488803204156
-1.0904202651202466    0.08167723722697048    0.011033877743107613
-1.0177240099802907    0.057058154764444535    0.01704681787584167
-0.6074141026889397    0.05733927288413837    0.027725882672407234
-0.8666368595597336    0.02064706509323965    0.035503431952781106
-0.48271304255785696    0.02351204296159876    0.02791903215046995
-0.6015216501198642    0.04600459219646906    0.008914455476785578
-0.5181042013288076    0.023829202595580495    0.0031290083480354862
-0.45685692749277274    0.02415891448979593    0.005187615673178414
-1.2391940808088013    0.025410579487713983    0.003060858464238444
-0.6268948791108934    0.04940399467825414    0.06680667086103233
-0.8222057490344682    0.04448346995316504    0.002558730178978552
-0.43741398896253747    0.014472643969835195    0.003984004464305271
-1.116958117599975    0.048982515195126745    0.0032025537145655603
-0.4191213305325328    0.028022481123328186    0.00416931486154979
-0.3058473527731904    0.008675911335960634    0.0037905534149998625
-0.5209966901606948    0.022831526571216395    0.003494846855399441
-1.0138223541073534    0.05059332642937085    0.004732541903290206
-0.5190305009395072    0.05377747781096412    0.005490256146879028
-1.0728044931395662    0.026012778376922462    0.01895049654419812
-1.8790258106416227    0.06341381424181196    0.008427555280462773
-1.3575433007756004    0.0830003896723553    0.0261713587755468
-0.9796712614153462    0.062187787505811845    0.04307148857051131
-1.6265582716268847    0.08135057538705007    0.05618415420612202
-0.8637362776175856    0.0349322468620471    0.02214549448004476
-0.46477181726915623    0.018742786561851434    0.05670054909656334
-0.7122110472262417    0.011379222792362982    0.058239147800724755
-0.7430011212754162    0.03476788270372625    0.047868910086889635
-0.6135545201060753    0.0305974149444057    0.017221990915494107
-0.9322824088385386    0.0730588218189028    0.00402717364073364
-0.5113919959282693    0.041219194531609354    0.00427107280200883
-0.5283984920607663    0.014860377644506016    0.0007588038870729629
-0.8391793627413803    0.04933597800692622    0.019996000487483217
-1.182074597860367    0.03433343734844869    0.05198400726785855
-0.9442186086843927    0.06362694748117242    0.0059142873946865515
-0.5521979717174926    0.033509646546995404    0.0030622404711373582
-0.808652083123091    0.054779484708658024    0.003613849987762157
-0.5185682446109584    0.03761389219940896    0.02444610096427555
-0.8434219908096617    0.036872554450337575    0.04803173823623572
-1.4119553097970896    0.06903728862915595    0.023884269342751206
-0.7094500650402695    0.026670516342353165    0.11878114612118526
-1.298522603072332    0.09392906381503097    0.05933578496418857
-1.0326491411150487    0.021962826499785395    0.1257927839303072
-1.1407792317115053    0.05118217806630995    0.06170935504012785
-1.1087172186594207    0.042536619954369394    0.044210662850331275
-1.0902242829733644    0.07541325716079929    0.007580642881800524
-0.711613240653467    0.052931286005192466    0.01762848144150293
-1.1346870470847306    0.06649183346690817    0.03390701306397807
-0.7546581951641239    0.04749422280025596    0.1487384407785932
-0.8772655026967395    0.06943237895124994    0.11522348158793637
-0.5929632368232042    0.032605003241478164    0.1686362248637167
-0.7538689936191736    0.048558953042936386    0.1482895905663546
-1.8738205800344252    0.06488629832657253    0.011332376787277682
-1.0020768089665948    0.05941085063398494    0.1393680096366244
-0.6138578348534125    0.0246973662484585    0.17117702437491814
-0.8836781126190285    0.054395409619800994    0.16532130441074125
-1.4415250025492339    0.09442277267606762    0.04184284475514079
-0.38336939292211747    0.01008289215636349    0.05895525360408876
-0.582741078726998    0.011404720094556078    0.058544991674929596
-0.8419908924154434    0.016371191262817362    0.055887963209468136
-1.011832029161519    0.057329852073318366    0.031919482714745734
-0.7233466288603962    0.0680114627006484    0.06596625836473079
-0.4248269292101753    0.007899292458981633    0.061006870605051965
-1.037528808788856    0.05111001744151957    0.09873091178580173
-0.8544332762661464    0.05157706699796206    0.10290644879445683
-0.6810991879226802    0.03226569380097763    0.11677697600791542
-0.7463893777744703    0.01219688173095654    0.13226254679798946
-0.800146269287979    0.05055077945780116    0.1049085202686656
-1.156201539887324    0.04051381755740543    0.11333554303518296
-0.5109855320792237    0.02361091788874069    0.05972656237685798
Binned Kinetic energy: -0.8833107905785279 ± 0.33859781700676334
Binned double occupation: 0.04574684168481303 ± 0.02240208993968187
Magnetization: 0.04054097828827296 ± 0.04410623288029019
```

靠全局变量传数据是不行的，于是我们来消除tau_now之类的东西。消除之后发现
```
Observables:
-1.2528695071175342    0.0841806619016127    0.00499672940869614
-0.7721832991306194    0.061447485223502026    0.005289386419573819
-0.9587153197304602    0.057492006822781196    0.004447379746395604
-0.9960269018347772    0.06401035595478112    0.03011255463090117
-1.1815379454855512    0.09733684442932473    0.004874039216005578
-1.085579102262616    0.054951045872121226    0.017895461238756266
-1.4246631755474426    0.04156725915030702    0.03420405426330849
-0.5843729484227802    0.03102791622473617    0.00789531815612362
-1.0812501642728176    0.041639384708977295    0.009125916693490194
-0.9482843493518015    0.07670379584536595    0.03545424328882862
-0.45539102096684    -0.03415800193305101    0.0017430792826046472
-0.4219676847119237    0.018255693478009465    0.0039055335748731947
-1.8157108504385424    0.05329893841726706    0.011624212809535685
-1.2135567397904823    0.09088710781425889    0.032162021994424216
-0.7107530103448996    0.03716471772647199    0.02529218672494915
-0.6551201220349393    0.014834303506385422    0.032314103347350465
-0.5180444417022227    0.020924199224171967    0.030908251626922734
-0.8893895776937553    0.058511707061395225    0.018591843329966867
-0.9260150099929956    0.04370976299713445    0.0026420273365469586
-1.4222982834571147    0.030897476673829437    0.006249515709471924
-2.787034805795029    0.0973807438672764    0.00538869768466382
-2.286156924062785    0.09125273763920522    0.005177149198635703
-0.6041506996411016    0.030659087454120104    0.006729759066759271
-1.1992388780758299    0.05685921803989419    0.01737810231386735
-1.4341155562534103    0.04829064585083709    0.02351853894912368
-0.5403217766441402    0.027969681074873083    0.006431133380963536
-0.945487418021395    0.02003719047700965    0.030418295815602334
-0.49772022632057544    0.002791579156085918    0.0018168542485499882
-0.8718444045211273    -0.14597570426339837    0.004050775297585843
-1.0114623482257166    0.03281697695654333    0.012540833573149177
-2.223246840827946    0.028482480452132666    0.0053107999399296104
-0.5429235899436282    0.024520246524747852    0.028547393108963773
-0.678932117667906    0.06423999893932335    0.005385625554503833
-0.5014415738921638    0.018395365048849137    0.003669854860101764
-0.7634316996517843    0.0494161205222234    0.003867277951596481
-0.5198094810287046    0.01919351130637676    0.029795982768510008
-0.984831444504008    0.05709532273765971    0.018801562357101953
-0.520213550630216    0.01676646108392042    0.005413891323582358
-0.6362631674782286    0.044673249419985024    0.002726703509348587
-0.4880524405147761    0.01874840967557187    0.004089075058350133
0.02128385343276684    0.009575673605574387    0.00637137066056354
-0.664869918887091    0.06579778997211967    0.005782215551691572
-0.5605461807882339    0.02583975154561035    0.02926428773948053
-0.5415483950647146    0.025278461548448924    0.03473481000660735
-0.688140846068203    0.038942000335277845    0.008275891856913473
-1.3611639360884387    0.039775072287873456    0.0238052847036439
-1.2182396097834884    0.05280647016375756    0.010935993299102342
-1.88963664031423    0.08089671634416849    0.004409957917420302
-0.3809366748990112    0.009290254055137238    0.03494552624500132
-0.9171163285896995    0.04102985191213081    0.07489861538532591
-1.0113383367261146    0.03207955037227116    0.015463429524326102
-0.4698739162860388    0.014410274860720619    0.03361655978254009
-1.2651636117870884    0.03916909470879655    0.005444678320494166
-1.179504818201896    0.046220861761169706    0.00494466393715162
-0.5674192548342113    0.033614281154295544    0.0397801871591246
-0.7322111754338314    0.04464669275815193    0.020260008639181953
-1.0793774584745865    0.06255382792481815    0.0033936353183951786
-1.397709129000294    0.10898662791692307    0.005796129236989122
-1.7660892769866536    0.08492329662749862    0.005227068917539305
-0.9805942545519092    0.03430129837071788    0.07794751327286954
-0.9763395186775964    0.10225291755496324    0.0029118444836051015
-1.1389111084527075    0.03894374409515244    0.03775306702075841
-2.106425904348944    0.11142554612874572    0.008559379790631327
-0.597161662950605    0.03887035638595152    0.0028700622888501058
-0.8544328645755233    0.07134458289885026    0.005356452827524712
-0.9998121944776951    0.0333400233442648    0.05798008098096159
-0.6888076983137517    0.039225933973920574    0.08142734267710681
-0.7726947847816141    0.02439043273845499    0.05269870569451788
-0.5270074329370511    0.01258834531520627    0.0150679382145357
-0.5873743754711116    0.028526129898086415    0.05199669204170731
-0.9547437764118251    0.06685518990326313    0.04083145135966271
-0.4894218934780556    0.016711003168026706    0.056061062449951564
-1.1667494872736754    0.047223146867494147    0.04371268153585353
-0.7153388651376216    0.062319250264239734    0.03409731743658888
-0.78839964384176    0.05154340629980996    0.008959080679589481
-0.663802904589089    0.03657102159863071    0.0020412114340771985
-1.8384775481441875    0.08346880416650235    0.027089305422941634
-0.8261785400033024    0.05625424800459894    0.08010432365162308
-0.7308769097350863    0.056165463191553036    0.003943270341636291
-0.7002245464712402    0.05715059138101581    0.004082014715471676
-0.0016730037306179057    -0.051963688790996825    0.007987018568529848
-0.6644371462200851    0.05321895532708038    0.0031462399250344435
-0.5687444659656071    0.0313557613651346    0.0019934656543009284
-0.5430914750276012    0.03859990554195102    0.00870049203578609
-0.6600244198058023    0.04866737124401778    0.006288154814412484
-1.3597212206110625    0.0566128970231267    0.003914161319342877
-0.5814399232408844    0.03809064373461395    0.0031139453060060884
-0.7401307260795571    0.030876158953403295    0.002531986136474642
-0.6812304946371716    0.0432576795005452    0.0028840537590511086
-0.9396572497192957    0.03583939864628105    0.0021131143286295014
-0.8822199234427264    0.04711072846945028    0.004985026087160587
-0.5060807504232059    0.009916682555159295    0.014957537214960626
-1.1062988569511516    0.054823002517818326    0.034824095257572615
-0.9555691075334787    -0.049044237064568036    -0.0009526198010875457
-1.2024335599986045    0.06863196159548071    0.08148214542069952
-0.8537750369133179    -0.041723550561895945    0.05860316492042609
-0.6410368238203304    0.029910214693396466    0.0511467731234429
-0.8478349176195812    0.057820799349000626    0.019105649540141552
-2.497850391098254    0.08351726626195884    0.019271550603082926
-1.094740020088571    0.060616359913216074    0.005448665155946902
Binned Kinetic energy: -0.934517754803229 ± 0.48604426282018814
Binned double occupation: 0.04119738278740986 ± 0.035061677954621395
Magnetization: 0.019351718966514858 ± 0.020552309294554493
```

# 2022.5.15

不管了，先把struct-based的程序弄出来再说。

$U = 4$：
```
Initialization completed.
We are simulating with
  t      =   1.0
  U      =   4.0
  beta   =   4.0
  dtau   =   0.1
  alpha  =   0.653732997987334
on a 4 * 4 2d lattice and with 40 time steps.

Double checking is on. During the calculation, the program double-checks the error between the optimized version of B-matrices, Green functions, etc. and their by-definition values.
This can be extremly slow. Turn off the marker when scaling up.

numerical error found in the double-check process
Heating up for 0 steps.
0
Heating up completed.

Observables:
====================================================
E_kin            double_occ    magnetization
====================================================
100
observed
6.831994074723672e-8
4.1578515234898474e-8
-1.0926557975    0.1361312169    0.0064533194 
observed
3.455043777167052e-8
1.9224997794582305e-7
-1.2896685476    0.1096366043    0.0973614289
observed
3.215202929338367e-9
1.0436927995845993e-8
-1.4093473375    0.1241639251    0.0562681794
observed
4.3387354412687343e-10
1.5352813930733646e-9
-0.9814794263    0.0987451221    0.1215697192
observed
8.635414187150666e-11
1.8177872345281507e-10
-1.2312475935    0.1229610845    0.0405095228
observed
3.0967023104448634e-12
8.996485293258567e-12
-1.2280487697    0.1307665812    0.0504709749
observed
1.3816374008207749e-12
1.266416053360358e-12
-0.9020120779    0.0654475157    0.1116539827
observed
1.6863486427522394e-13
1.3474484942331283e-13
-1.2545846298    0.1421142493    0.0081119991
observed
2.6110401444037907e-14
9.187726822548381e-15
-1.3184352621    0.1236292172    0.0209115743
observed
1.1129901499198092e-14
7.589374518946842e-15
-0.7923711630    0.0648406889    0.0052161240
observed
3.541597901907046e-6
6.9504748031233246e-6
-1.3939086928    0.1582609340    0.0076417838
observed
8.173488622223837e-7
2.288982166095524e-6
-1.9694787883    0.1312210083    0.0536395781
observed
1.4761851646383983e-8
7.313534654697496e-8
-1.2215072314    0.1475669977    0.0140057470
observed
9.782038608540475e-10
2.5372094186102845e-10
-1.2911664312    0.1355684815    0.0452907650
observed
1.0503352069904279e-10
3.5287574616393224e-10
-1.2578999480    0.1494317695    0.0120364085
observed
1.523904669638072e-11
2.504067052256067e-12
-1.5729536097    0.1468808473    0.0268370395
observed
6.595791451173769e-13
3.78737110977732e-13
-1.4621667019    0.1289758823    0.0164794450 
observed
8.799057710115247e-14
9.014188806722161e-14
-1.2166217177    0.1400119264    0.0134419737
observed
1.6250644648875775e-14
3.419277575235638e-14
-1.4298403674    0.1617627475    0.0096601759
observed
7.830088905870037e-15
8.194293526901205e-15
-1.6600292124    0.1675500748    0.0184748577
observed
2.4234884926127165e-6
4.741210480872307e-6
-1.4815070686    0.1292384491    0.0332452178
observed
2.581962561399003e-7
5.803095927865563e-7
-1.2263211908    0.1138316925    0.0055551474
observed
1.0376845732766191e-7
9.946532756427062e-8
-1.1798124569    0.1163910220    0.0061953831 
observed
1.149852028247408e-8
7.739411390352223e-9
-1.5561274213    0.1634085076    0.0081788997 
observed
3.428406550470017e-10
2.1040157775576746e-10
-1.3511719651    0.1079906749    0.0197270080
observed
1.512186607413764e-11
1.71997720062182e-11
-1.4923581330    0.1522523680    0.0631339242
observed
1.0324613975431532e-12
2.6527919764594794e-12
-1.7767752174    0.1705109658    0.0475234528
observed
8.858483669286681e-14
1.1776709987194582e-13
-1.1408275591    0.1348251230    0.0110491718 
observed
3.3490258404810324e-14
1.421967834683428e-14
-1.4120811040    0.1196606165    0.0081843750 
observed
9.720569716709893e-15
4.269043544746738e-15
-1.0880773576    0.1075323903    0.0618941440 
observed
4.9819178111052905e-6
1.5571103203601207e-5
-1.1054085197    0.0913513117    0.0100371607 
observed
1.3070519714097744e-7
2.3612815678744684e-7
-1.6411188907    0.1907483950    0.0130654584 
observed
4.964048428843724e-9 
1.6262945403159147e-9
-1.2368499410    0.0937844662    0.1163558229
observed
1.319371326211755e-9
1.1490280598261491e-9
-1.0747859719    0.0993237862    0.0073336983
observed
1.192387344886722e-10
7.417028483425079e-11
-1.2210541202    0.1130021686    0.0056982767
observed
3.9769772431216696e-12
6.9564947482356806e-12
-1.4979524712    0.1066021330    0.0055331485 
observed
2.060701358927559e-12
2.6603989994724866e-12
-1.5825037279    0.1630160974    0.0081838181
observed
1.02591013316914e-13
8.367152609426057e-14
-1.8014277204    0.1680899881    0.0088530037
observed
1.8923390872266587e-14
2.325973561529375e-14
-1.4119508211    0.0965253445    0.0211781819
observed
9.978289088541102e-15
1.1790150128520174e-14
-1.8137241756    0.1495729654    0.0632021006
observed
1.4782628804022408e-6
1.624126972080661e-6
-1.4173280665    0.1241732031    0.0417069044
observed
1.6645331627497288e-7
2.6820974845058175e-7
-1.4797723949    0.1351041155    0.0773910210
observed
9.469490346886779e-9
1.5188320511871564e-9
-1.0499372770    0.0982062968    0.0804199903
observed
7.212590298824549e-10
2.649334729981922e-10
-1.1744439486    0.0831052599    0.1128407399
observed
1.1205129765427948e-11
6.591353065268605e-11
-1.3556250549    0.1185757310    0.0993544918
observed
2.6958197584657852e-12
4.068180952418324e-12
-1.4482228032    0.1550890444    0.0361443245
observed
1.9051611036585186e-12
9.130802716476758e-13
-1.3335153103    0.1113548438    0.0081576603
observed
3.836062220315394e-13
2.1357548168152335e-13
-1.3758514856    0.1363289102    0.0344933717
observed
2.5462048018752372e-14
2.6090644470360845e-14
-2.0520221812    0.1598149064    0.0285453902
observed
6.725738197504048e-15
6.795704213941629e-15
-1.3687817464    0.1635177211    0.0117120204
observed
1.6269462387370225e-6
6.780672283207308e-7
-1.3690771419    0.1274718791    0.0518811390
observed
2.011524271898484e-6
4.065516485099584e-7
-1.2436141541    0.1288694148    0.0276917361
observed
1.5793120065366647e-8
8.404774171027838e-9
-1.4450186171    0.1348064177    0.0208466903
observed
1.5966604906112094e-9
5.814042747186104e-9
-1.3627230390    0.1692698046    0.0099667155
observed
7.896479015562398e-11
1.6165881693554324e-10
-1.0598703541    0.0906136626    0.0051339056
observed
8.100103243720786e-12
3.934820276717371e-12
-1.1486951254    0.0931956195    0.0234980130
observed
2.0359695357450437e-13
2.798441874045599e-13
-1.3157193029    0.1009392405    0.0057398251
observed
7.137753382602359e-14
6.076722551962203e-14
-1.5101511855    0.1684136205    0.0085372316
observed
2.1824303773383196e-14
1.464434145426856e-14
-1.0806239632    0.0956778069    0.0366460728
observed
7.8487088734923e-15
6.9889375403007745e-15
-1.2187767965    0.1230883746    0.0082077836
observed
6.335961858876701e-6
1.2866950842551932e-5
-1.5794781767    0.1296117495    0.0089414907
observed
4.372019319624721e-7
3.519901501598829e-7
-1.0492511293    0.0893367181    0.0319951571
observed
9.30879956891241e-9
6.144755602870867e-9
-1.2730134307    0.1173037497    0.0056318041
observed
2.187886258964122e-9
4.439408377878352e-10
-1.1728817739    0.1145646850    0.0090352658
observed
1.521317800564462e-10
1.1008720698456413e-10
-1.0636538916    0.1304117655    0.0065767051
observed
1.0581012446514953e-11
2.8987138632349105e-12
-1.3657244984    0.1288852627    0.0096221190
observed
4.993289954133333e-13
5.367178252902186e-13
-1.2433784105    0.1132734892    0.0913862097
observed
5.533976291268322e-14
9.797824743792218e-14
-1.3481481645    0.1170765574    0.0812274532
observed
1.3503899025236002e-14
1.33808321152433e-14
-0.9621895924    0.1122491881    0.0057142896
observed
1.1092521725250231e-14
3.4219032972032112e-15
-1.3704758908    0.1132979874    0.0457622235
observed
1.871609169391539e-5
5.632293336869471e-6
-1.9945644909    0.1304716416    0.0174370558
observed
2.8144673814271493e-7
2.3894365485832555e-8
-1.5506500887    0.1398755601    0.0067077656
observed
1.0668538313790278e-8
1.6663775017679123e-8
-1.4695946281    0.1185625553    0.1097514380
observed
4.071080857091785e-10
1.2245639609973083e-9
-1.6374967534    0.1436378440    0.0072653527
observed
6.753684836100439e-10
1.185524042951483e-10
-1.0923618331    0.1072802575    0.1103586932
observed
1.173133175190084e-12
6.61208271912521e-12
-1.1679174298    0.1422613141    0.0069495037
observed
3.566063465342934e-13
1.9833533889281115e-13
-1.5496545403    0.1143680733    0.0201139799 
observed
5.684704692285672e-14
1.587395404798111e-13
-1.1095802950    0.1261196142    0.0095556819
observed
1.8451116425013224e-14
1.545510931394857e-14
-1.2663206594    0.1198591443    0.0233622927
observed
1.5442274006114466e-14
5.7250968272856066e-15
-1.3382078207    0.1277872188    0.0200332320 
observed
1.1714346834151692e-6
6.000009540830856e-6
-1.3342536158    0.1307007014    0.0213258204
observed
6.142802977087255e-7
2.3512678184335448e-7
-1.8209136385    0.1667992444    0.0074383110
observed
3.9280327114436345e-9
3.1285531988288906e-9
-1.1553770439    0.1380630488    0.0265864995
observed
1.0271788606963414e-9
5.067453137160586e-10
-1.7568251869    0.1467436023    0.0382024212
observed
7.271117487595209e-11
5.984020873924608e-11
-1.3317573454    0.1245256699    0.0676067558
observed
3.0502293141333905e-11
8.769669388399862e-12
-1.2175113415    0.1066558674    0.1014808048
observed
9.992482123486419e-13
8.81065050013178e-13
-1.0564750105    0.0718702055    0.0931123483
observed
1.2178283865579473e-13
7.415182541687345e-14
-1.0995607825    0.1055542707    0.0589947565
observed
1.069420139321056e-14
1.360154899562e-14
-1.2496506520    0.1416605665    0.0440886446
observed
1.528971265243593e-14
5.659869746629184e-15
-1.4079159425    0.1053674686    0.1451012985
observed
3.3418149169543074e-6
1.23083231781257e-5
-1.1629681124    0.0915234724    0.1518760310
observed
5.062430885347908e-7
1.7001659176002848e-7
-0.9246804099    0.0548710367    0.1083827589
observed
3.154794451804097e-8
2.535025847389176e-8
-1.2407877307    0.1183892258    0.0268684093
observed
1.7357516578181017e-9
8.258601608584903e-10
-1.4883046172    0.1529782737    0.0146468428
observed
8.719072062472141e-11
7.825372071543353e-11
-1.5121107593    0.1220527712    0.0171346088
observed
8.015218194731053e-12
6.549169910192131e-12
-1.4715489843    0.1328661538    0.0142738976
observed
5.318446320364015e-13
2.852442948667242e-13
-1.2870253768    0.1212370870    0.0383017931
observed
1.9538346802441259e-13
6.167730243514683e-14
-0.9694025362    0.0948299069    0.0207026291
observed
1.715181468879747e-14
3.856914995302333e-14
-1.3979259310    0.1427681834    0.0541693582
observed
4.908817149680561e-15
1.1840610600362537e-14
-1.0931302820    0.0845372742    0.0489334278
Bin 1 completed.
E_kin      =   -1.3345969788523586 ± 0.24004737730955228
double_occ =   0.12481169619191233 ± 0.025873801601944763
mag        =   0.03715732149683755 ± 0.03638240176796228
```
感觉结果还可以。提交这个修改了。

# 2022.5.16

开始简化$B$矩阵乘法。

创建`test.jl`，在其中检验一些等价关系。
发现`B_up_inv`似乎有一个实现漏洞：
```julia
exp(Δτ * T_kin) * diagm(- exp.(α * s_τ[τ, :]))
```
应当替换为
```julia
exp(Δτ * T_kin) * diagm(exp.(- α * s_τ[τ, :]))
```
做此替换，观察结果。结果为
```
Initialization completed.
We are simulating with
  t      =   1.0
  U      =   4.0
  beta   =   4.0
  dtau   =   0.1
  alpha  =   0.653732997987334
on a 4 * 4 2d lattice and with 40 time steps.
Heating up for 0 steps.
Heating up completed.

Observables:
====================================================
E_kin            double_occ    magnetization
====================================================
-1.3306362254    0.1227608073    0.0502124690 
-1.0649645345    0.0841645670    0.0190695283
-1.1449472762    0.1098459439    0.0069691467
-1.3978210849    0.1467843149    0.0108270716
-1.0672943562    0.1033162439    0.0059038096
-1.0710391613    0.1138917834    0.0087303530
-1.2769946218    0.0905547558    0.0102132596
-1.1965327590    0.1401542972    0.0468334983
-1.2286701066    0.1013250743    0.1027456727
-1.0174359329    0.1052758663    0.0651367397
-1.3713455068    0.1273264616    0.0482105229
-1.2301139855    0.1115806484    0.0310143870
-1.2252458449    0.1412168711    0.0621638354
-1.0070654085    -0.0003986019    0.1017553368
-1.4627930670    0.1115135944    0.0120485677
-1.0174931815    0.0804264982    0.0065954154
-1.2051901772    0.0924455664    0.0201418063
-0.9961181176    0.0898703078    0.0844041571
-1.5714813894    0.1208412746    0.0854291889 
-1.3069260791    0.1483646267    0.0174554694 
Bin 1 completed.
E_kin      =   -1.2095054408281423 ± 0.16407850450359945
double_occ =   0.10706304505501045 ± 0.0325255893357668
mag        =   0.039793011777612866 ± 0.03357253430400664



Binning results:
-------------------------------------------------------------
E_kin      =   -1.2095054408281423 ± NaN
double_occ =   0.10706304505501045 ± NaN
mag        =   0.039793011777612866 ± NaN
```
也不知道算不算好……

```julia
τ = 3
relative_err(inv(B_dn(model, τ)), B_dn_inv(model, τ))
```
测试通过。

做了将`inv(B_up)`替换成`B_up_inv`以后，得到
```
Observables:
====================================================
E_kin            double_occ    magnetization
====================================================
-1.4893083164    0.1573078393    0.0259543764
-1.2809590344    0.1483072776    0.0183091595 
-1.4869235087    0.1707734180    0.0176002117 
-1.1237865892    0.1125241887    0.0066450355 
-1.2940403718    0.1490469395    0.0113387455 
-1.5093484648    0.1618090049    0.0090949313 
-1.1303941992    0.1351300730    0.0077841246 
-1.5043552471    0.1500667900    0.0581802292 
-1.0148713105    0.0903448707    0.1133617933 
-1.1271157048    0.0898710355    0.1590576042 
-1.2804309528    0.1351582231    0.0777432640 
-1.1290686167    0.0790006467    0.1718502137 
-1.2086788389    0.1127616449    0.0625779483 
-1.8673398335    0.1467879618    0.0557219687 
-0.8546348459    0.0689712962    0.0248422747 
-1.4564052541    0.1484106467    0.0417957629 
-1.3556528657    0.1063694434    0.0681921133 
-1.2180916397    0.0910689510    0.1582669856 
-1.5579460387    0.1491664669    0.0416325417 
-1.7338144676    0.1465469632    0.0436018603 
Bin 1 completed.
E_kin      =   -1.3311583050230928 ± 0.24661032815889727
double_occ =   0.12747118404685698 ± 0.03068728954091031
mag        =   0.05867755722522276 ± 0.0526173702415574



Binning results:
-------------------------------------------------------------
E_kin      =   -1.3311583050230928 ± NaN
double_occ =   0.12747118404685698 ± NaN
mag        =   0.05867755722522276 ± NaN
```